<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e40af">
    
    <title>Dashboard - THREE FOLD VENTURES</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="/static/dashboard.css">
    
    <!-- Content Protection JS -->
    <script src="/static/content-protection.js" defer></script>
    
    <style>
        /* Inline styles for dynamic colors */
        .subject-enrollment-card {
            border-left-color: var(--subject-color, #1e40af);
        }
        
        .subject-btn, .code-badge {
            background-color: var(--subject-color, #1e40af);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">TFV</div>
                <div class="logo-text">THREE FOLD VENTURES</div>
            </div>
            
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="/"><i class="fas fa-home"></i> Home</a>
                <a href="/subjects"><i class="fas fa-book"></i> Subjects</a>
                <a href="/pricing"><i class="fas fa-tag"></i> Pricing</a>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-profile">
                <div class="user-avatar">
                    {{ current_user.name[0] if current_user.name else 'S' }}
                </div>
                <h3>{{ current_user.name or 'Student' }}</h3>
                <p>{{ current_user.email }}</p>
                {% if current_user.student_id %}
                <p><small>ID: {{ current_user.student_id }}</small></p>
                {% endif %}
            </div>

            <nav class="sidebar-nav">
                <a href="/dashboard" class="active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/profile">
                    <i class="fas fa-user"></i> My Profile
                </a>
                <a href="/subjects">
                    <i class="fas fa-book-open"></i> All Subjects
                </a>
                <a href="/pricing">
                    <i class="fas fa-credit-card"></i> Make Payment
                </a>
                <a href="#">
                    <i class="fas fa-chart-line"></i> Progress Report
                </a>
                <a href="#">
                    <i class="fas fa-question-circle"></i> Help & Support
                </a>
            </nav>

            <!-- Payment Status -->
            <div class="payment-status">
                <h4><i class="fas fa-info-circle"></i> Access Status</h4>
                {% if payment %}
                    <p class="status-active">✅ Active until {{ payment.end_date.strftime('%d %b %Y') }}</p>
                    <p><small>Paid: {{ payment.amount }} MWK for {{ payment.weeks }} week(s)</small></p>
                {% else %}
                    <p class="status-inactive">❌ No active payment</p>
                    <p><small><a href="/pricing" style="color: #1e40af;">Click here to pay</a></small></p>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1>Welcome to Your Learning Dashboard</h1>
            <p>Track your progress and continue your learning journey</p>

            <!-- Quick Stats -->
            <div class="stats-cards">
                <div class="stat-card">
                    <h3>{{ enrollments|length }}</h3>
                    <p>Enrolled Subjects</p>
                </div>
                <div class="stat-card">
                    <h3>{{ payment.weeks if payment else 0 }}</h3>
                    <p>Weeks Paid</p>
                </div>
                <div class="stat-card">
                    <h3>{{ available_subjects|length }}</h3>
                    <p>Available Subjects</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="/payment-options" class="action-btn">
                    <i class="fas fa-credit-card"></i> Make Payment
                </a>
                <a href="/subjects" class="action-btn secondary">
                    <i class="fas fa-plus-circle"></i> Enroll New Subject
                </a>
                <a href="/profile" class="action-btn secondary">
                    <i class="fas fa-user-edit"></i> Update Profile
                </a>
            </div>

            <!-- My Subjects -->
            <h2>My Enrolled Subjects</h2>
            {% if enrollments %}
            <div class="subjects-grid">
                {% for enrollment in enrollments %}
                <div class="subject-enrollment-card" style="--subject-color: {{ enrollment.subject.color or '#1e40af' }}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; gap: 0.5rem;">
                        <h3 style="flex: 1; margin: 0;">{{ enrollment.subject.name }}</h3>
                        <span class="code-badge">{{ enrollment.subject.code }}</span>
                    </div>
                    <p>{{ enrollment.subject.description[:100] }}...</p>

                    <!-- Progress -->
                    <div style="margin: 1rem 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <span>Progress</span>
                            <span>{{ enrollment.progress_percentage }}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ enrollment.progress_percentage }}%"></div>
                        </div>
                    </div>

                    <a href="{{ url_for('subject_detail', subject_id=enrollment.subject.id) }}"
                       class="subject-btn">
                       <i class="fas fa-play-circle"></i> Continue Learning
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>No Enrolled Subjects</h3>
                <p>You haven't enrolled in any subjects yet.</p>
                <a href="/subjects" class="enroll-btn">
                    <i class="fas fa-search"></i> Browse Subjects
                </a>
            </div>
            {% endif %}

            <!-- Available Subjects -->
            <h2>Available Subjects</h2>
            <div class="subjects-grid">
                {% for subject in available_subjects if subject.id not in enrollments|map(attribute='subject_id') %}
                <div class="subject-enrollment-card" style="--subject-color: {{ subject.color or '#1e40af' }}; border: 2px dashed #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
                        <div style="background: var(--subject-color); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="{{ subject.icon or 'fas fa-book' }}"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.25rem 0;">{{ subject.name }}</h3>
                            <p style="font-size: 0.85rem; color: #6b7280; margin: 0;">{{ subject.code }}</p>
                        </div>
                    </div>
                    <p>{{ subject.description[:80] }}...</p>

                    {% if payment %}
                    <a href="{{ url_for('enroll', subject_id=subject.id) }}"
                       class="enroll-btn">
                       <i class="fas fa-user-plus"></i> Enroll Now
                    </a>
                    {% else %}
                    <div class="payment-warning">
                        <i class="fas fa-lock"></i> Make payment to enroll
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Mobile Menu Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile Menu Toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navLinks = document.getElementById('navLinks');
            
            if (mobileMenuToggle && navLinks) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navLinks.classList.toggle('active');
                    mobileMenuToggle.classList.toggle('active');
                    
                    // Toggle menu icon
                    const icon = mobileMenuToggle.querySelector('i');
                    if (icon) {
                        if (navLinks.classList.contains('active')) {
                            icon.classList.remove('fa-bars');
                            icon.classList.add('fa-times');
                        } else {
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    }
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('.nav-container') && navLinks.classList.contains('active')) {
                        navLinks.classList.remove('active');
                        mobileMenuToggle.classList.remove('active');
                        const icon = mobileMenuToggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    }
                });
                
                // Close menu when clicking on a link
                navLinks.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        navLinks.classList.remove('active');
                        mobileMenuToggle.classList.remove('active');
                        const icon = mobileMenuToggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    });
                });
            }
            
            // Make all buttons touch-friendly
            const interactiveElements = document.querySelectorAll(
                'button, .action-btn, .subject-btn, .enroll-btn, a.btn, .sidebar-nav a, .nav-links a'
            );
            
            interactiveElements.forEach(element => {
                // Ensure minimum touch target size
                if (element.offsetWidth < 44 || element.offsetHeight < 44) {
                    element.style.minWidth = '44px';
                    element.style.minHeight = '44px';
                }
                
                // Add active state for touch feedback
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                    this.style.transform = 'scale(0.98)';
                }, { passive: true });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '';
                    this.style.transform = '';
                }, { passive: true });
            });
            
            // Prevent iOS zoom on input focus
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], textarea');
            inputs.forEach(input => {
                input.addEventListener('touchstart', function(e) {
                    // iOS-specific: prevent zoom when tapping input
                    if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                        this.style.fontSize = '16px';
                    }
                });
            });
            
            // Update progress bars with animation
            const progressBars = document.querySelectorAll('.progress-fill');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 300);
            });
            
            // Handle page loading state
            window.addEventListener('load', function() {
                document.body.classList.remove('loading');
            });
            
            // Add loading state during navigation
            document.querySelectorAll('a[href^="/"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    // Don't intercept external links or links with special attributes
                    if (this.target === '_blank' || this.hasAttribute('download')) {
                        return;
                    }
                    
                    const href = this.getAttribute('href');
                    if (href && href !== '#' && !href.includes('javascript:')) {
                        document.body.classList.add('loading');
                    }
                });
            });
        });
        
        // Handle back/forward navigation
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                document.body.classList.remove('loading');
            }
        });
    </script>
</body>
</html>
